{{ define "content" }}
<div class="p-2"></div>
<div class="container">
  <div class="row">
    <div class="col"><h4>Timestamp</h4></div>
    <div class="col"><h4>Transformer</h4></div>
    <div class="col"><h4>Currency</h4></div>
    <div class="col"><h4>Amount</h4></div>
    <div class="col"><h4>Transation Type</h4></div>
  </div>
  {{ range $t := .Transactions }}
    <div data-uid="{{ $t.UID }}" class="row border-top p-1 {{ if .DetectedType.ShouldCheck }}bg-check{{ end }}">
      <div class="col">{{ $t.Timestamp }}</div>
      <div class="col">{{ $t.Transformer }}</div>
      <div class="col">{{ $t.Currency }}</div>
      <div class="col">{{ $t.Amount }}</div>
      <div class="col">
        <select class="form-select form-select-sm override-transaction-type">
          {{ range $tt := $.OverrideTransactionTypes }}
            <option {{ if eq .Int $t.DetectedType.Int }} selected {{ end }} value={{ .Int }} >{{ .String }}</option>
          {{ end }}
        </select>
      </div>
    </div>
  {{ end }}
  <a id="calculate" class="btn btn-primary">Calculate</a>
</div>

<div class="modal" tabindex="-1" role="dialog" id="result-modal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Calculations</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <div id="result" class="container-fluid"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
  .bg-check {
    background-color: #ffe5d0;
  }
</style>
<script>
  var transactions = JSON.parse({{.TransactionsJSON}})

  /*
   * Forgive me for this horrible hacky JS. I need to use some Javascript Framework with
   * 2 way binding to clean this up. Not worth it just for a single page though.
   */
  $(document).ready(function() {
    if (localStorage.getItem('transactions')) {
      var storedJsonString = localStorage.getItem('transactions')
      var storedJsonObject = JSON.parse(storedJsonString)

      $.each(transactions, function(key, t1) {
        $.each(storedJsonObject, function(key, t2) {
          if (t1.UID === t2.UID) {
            if (parseInt(t2.OverridedType) <= 0) {
              return false
            }
            if (t1.OverridedType === t2.OverridedType) {
              return false
            }

            transactions[key].OverridedType = t2.OverridedType
            let parent = $('[data-uid=' + t1.UID + ']')
            let e = parent.find('.override-transaction-type')
            e.val(t2.OverridedType)

            if (transactions[key].OverridedType === transactions[key].DetectedType) {
              e.removeClass('text-success')
            } else {
              parent.removeClass('bg-check')
              e.addClass('text-success')
            }
          }
        })
      })
    }
  })

  $(".row").on('click', function(e){
    $(this).removeClass('bg-check')
  })

  $('select').on('change', function(e){
    let uid = $(this).closest('.row').attr("data-uid")
    let val = $(this).val()
    let that = this
    $.each(transactions, function(key, t) {
      if (t.UID === uid) {
        transactions[key].OverridedType = parseInt(val)
        if (transactions[key].OverridedType === transactions[key].DetectedType) {
          $(that).removeClass('text-success')
        } else {
          $(that).addClass('text-success')
        }
        return false
      }
    })

    localStorage.setItem('transactions', JSON.stringify(transactions))
  })

  $("#calculate").on("click", function(e){
    $.ajax({
      url: "/ajax/calculate",
      type: "POST",
      data: JSON.stringify(transactions),
      contentType: "application/json",
      success: function(response) {
        html = convertTaxesToHTML(response)

        $('#result-modal').modal('show')
        $("#result").html(html)

        console.log(response)
      },
      error: function(xhr, status, error) {
        // Handle the error
        console.error(error)
      }
    })
  })

  function convertTaxesToHTML(allYearTaxes) {
    let html = '<table style="width:100%">'
    $.each(allYearTaxes, function(year, calcs) {
      html += '<tr><td colspan=2><h4>' + year + '</h4></td></tr>'
      $.each(calcs, function(currency, amount) {
        html += '<tr><td class="border-right">' + currency + '</td><td>R' + amount.toFixed(2) + '</td></tr>'
      })
      html += '<tr class="border-top"></tr>'
    })
    html += '</table>'

    return html
  }
</script>
{{ end }}